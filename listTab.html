<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="js/mui.min.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" charset="utf-8">
			mui.init();
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" id="title"></h1>
		</header>
		<div class="mui-content">
			<div class="mui-content-padded">
				<div id="slider" class="mui-slider mui-fullscreen">
					<div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
						<div class="mui-scroll" id="tab"></div>
					</div>
					<div class="mui-slider-group" id="list">

					</div>
				</div>
			</div>
		</div>
		<script src="js/template.js" type="text/javascript" charset="utf-8"></script>
		<script id="tmpl_list" type="text/html">
			{{if id>0}}
			<div id="tab{{id}}" class="mui-slider-item mui-control-content">
			{{else}}
			<div id="tab{{id}}" class="mui-slider-item mui-control-content mui-active">
			{{/if}}
				<div id="scroll{{id}}" class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							{{each list as value i}}
							<li class="mui-table-view-cell">
								{{value.subject}}
							</li>
							{{/each}}
						</ul>
					</div>
				</div>
			</div>
		</script>
		<script src="js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.pullToRefresh.js"></script>
		<script src="js/mui.pullToRefresh.material.js"></script>
		<script type="text/javascript">
			mui.plusReady(function() {
				if (plus.networkinfo.getCurrentType() == plus.networkinfo.CONNECTION_NONE) {
					mui.toast("当前网络不给力，无法加载广告");
				} else {
					var self = plus.webview.currentWebview();
					document.getElementById("title").innerText = self.title;
					//屏幕真实宽度
					var height = window.innerHeight;
					//根据投放广告的比例，计算广告高度
					var adHeight = parseInt(height) - 45;
					var url = self.url;
					var ad = plus.webview.create(url, 'ad', {
						height: adHeight + 'px',
						top: '45px'
					});
					//目前Android平台不支持子webview的setStyle动画，因此分平台处理；
					if (mui.os.ios) {
						//为了支持iOS平台左侧边缘滑动关闭页面，需要append进去；
						self.append(ad);
					} else {
						ad.addEventListener('loaded', function() {
							ad.show();
						});
					}
				}
			});
			(function($) {
				//阻尼系数
				var deceleration = mui.os.ios?0.003:0.0009;
				$('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration:deceleration
				});
				$.plusReady(function() {
					var self = plus.webview.currentWebview();
					document.getElementById("title").innerText = self.title;	//标题
					var tab="";
					var list="";
					var submenus=self.submenus;
					for(i=0;i<submenus.length;i++){
						$.ajax(submenus[i].url,{
							dataType:"json",
							async:false,
							success:function(data){
								if(data.errorPage){
									 
								}else{
									var obj={};
									obj.id=i;
									obj.count=data.count;
									obj.list=data.docs; 
									list+=template("tmpl_list",obj);
									console.log(list);
								}
							}
						})
						if(i==0){
							var count;
							tab+='<a class="mui-control-item mui-active" href="tab'+i+'">'+submenus[i].name+(count?'('+count+')':'')+'</a>';
						}else{
							tab+='<a class="mui-control-item" href="tab'+i+'">'+submenus[i].name+'</a>';
						}
					}
					document.getElementById("tab").innerHTML=tab;
					document.getElementById("list").innerHTML=list;
					
					//循环初始化所有下拉刷新，上拉加载。
					$.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
						$(pullRefreshEl).pullToRefresh({
							down: {
								callback: function() {
									var self = this;
									setTimeout(function() {
										var ul = self.element.querySelector('.mui-table-view');
										ul.insertBefore(createFragment(ul, index, 10, true), ul.firstChild);
										self.endPullDownToRefresh();
									}, 1000);
								}
							},
							up: {
								callback: function() {
									var self = this;
									setTimeout(function() {
										var ul = self.element.querySelector('.mui-table-view');
										ul.appendChild(createFragment(ul, index, 5));
										self.endPullUpToRefresh();
									}, 1000);
								}
							}
						});
					});
					var createFragment = function(ul, index, count, reverse) {
						var length = ul.querySelectorAll('li').length;
						var fragment = document.createDocumentFragment();
						var li;
						for (var i = 0; i < count; i++) {
							li = document.createElement('li');
							li.className = 'mui-table-view-cell';
							li.innerHTML = '第' + (index + 1) + '个选项卡子项-' + (length + (reverse ? (count - i) : (i + 1)));
							fragment.appendChild(li);
						}
						return fragment;
					};
				});
			})(mui);
		</script>
	</body>

</html>